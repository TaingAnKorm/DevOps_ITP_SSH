---
- name: Ensure SSH Public Key Exists On Jenkins Server
  ansible.builtin.stat:
    path: "{{ ssh_pubkey_path }}"
  register: ssh_pubkey_stat
- name: Generate SSH Keypair If Missing (On Jenkins Server)
  ansible.builtin.command: ssh-keygen -t ed25519 -f "{{ ssh_privkey_path }}" -N ""
  args:
    creates: "{{ ssh_privkey_path }}"
  when: not ssh_pubkey_stat.stat.exists
- name: Slurp SSH Public Key From Jenkins Server
  ansible.builtin.slurp:
    src: "{{ ssh_pubkey_path }}"
  register: ssh_pubkey
- name: Create GCP Master Instances
  google.cloud.gcp_compute_instance:
    name: "{{ item.name }}"
    machine_type: "{{ item.machine_type }}"
    zone: "{{ item.zone }}"
    project: "{{ google_project_id }}"
    auth_kind: application
    state: present
    metadata:
      ssh-keys: "{{ agent_user }}:{{ ssh_pubkey['content'] | b64decode }}"
    disks:
      - auto_delete: true
        boot: true
        initialize_params:
          source_image: "{{ item.image }}"
          disk_size_gb: "{{ item.disk_size }}"
          disk_type: "{{ item.disk_type }}"
    network_interfaces:
      - network:
          selfLink: "projects/{{ google_project_id }}/global/networks/default"
        access_configs:
          - name: External NAT
            type: ONE_TO_ONE_NAT
    tags:
      items: [http-server, https-server]
  loop: "{{ machines_info }}"
  when: item.name in ["master01", "master02", "master03"]
  register: gcp_masters
  environment:
    GOOGLE_APPLICATION_CREDENTIALS: "{{ adc_file }}"
    GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES: "1"
- name: Query Master Instance Info (Authoritative)
  google.cloud.gcp_compute_instance_info:
    project: "{{ google_project_id }}"
    zone: "{{ item.zone }}"
    filters:
      - "name = {{ item.name }}"
    auth_kind: application
  loop: "{{ machines_info }}"
  when: item.name in ["master01", "master02", "master03"]
  register: master_info
  environment:
    GOOGLE_APPLICATION_CREDENTIALS: "{{ adc_file }}"
    GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES: "1"
- name: Add Masters To In-Memory Inventory (From Instance_Info)
  ansible.builtin.add_host:
    name: "{{ inst.name }}"
    groups: masters
    ansible_host: "{{ inst.networkInterfaces[0].accessConfigs[0].natIP }}"
    internal_ip: "{{ inst.networkInterfaces[0].networkIP }}"
    ansible_user: "{{ agent_user }}"
    ansible_ssh_private_key_file: "{{ ssh_privkey_path }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  vars:
    inst: "{{ item.resources[0] }}"
  loop: "{{ master_info.results }}"
  when:
    - item.resources is defined
    - item.resources | length > 0
    - inst.networkInterfaces is defined
    - inst.networkInterfaces | length > 0
    - inst.networkInterfaces[0].accessConfigs is defined
    - inst.networkInterfaces[0].accessConfigs | length > 0
- name: Wait For SSH On Master01 (NAT IP)
  ansible.builtin.wait_for:
    host: "{{ inst.networkInterfaces[0].accessConfigs[0].natIP }}"
    port: 22
    delay: 5
    timeout: 300
  vars:
    inst: "{{ item.resources[0] }}"
  loop: "{{ master_info.results }}"
  when:
    - item.resources is defined
    - item.resources | length > 0
    - inst.name == "master01"
    - inst.networkInterfaces[0].accessConfigs | length > 0
- name: Ensure Master01 Exists In Inventory For Delegate_To
  ansible.builtin.add_host:
    name: master01
    groups: masters
    ansible_host: "{{ inst.networkInterfaces[0].accessConfigs[0].natIP }}"
    internal_ip: "{{ inst.networkInterfaces[0].networkIP }}"
    ansible_user: "{{ agent_user }}"
    ansible_ssh_private_key_file: "{{ ssh_privkey_path }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  vars:
    inst: "{{ item.resources[0] }}"
  loop: "{{ master_info.results }}"
  when:
    - item.resources is defined
    - item.resources | length > 0
    - item.resources[0].name == "master01"
    - item.resources[0].networkInterfaces[0].accessConfigs | length > 0
- name: Ensure .ssh Directory Exists On Master01
  ansible.builtin.file:
    path: "/home/{{ agent_user }}/.ssh"
    state: directory
    owner: "{{ agent_user }}"
    group: "{{ agent_user }}"
    mode: "0700"
  delegate_to: master01
  become: true
- name: Copy SSH private key to master01 for pivoting
  no_log: true
  ansible.builtin.copy:
    src: "{{ ssh_privkey_path }}"
    dest: "/home/{{ agent_user }}/.ssh/id_ed25519"
    owner: "{{ agent_user }}"
    group: "{{ agent_user }}"
    mode: "0600"
  delegate_to: master01
  become: true
- name: Copy SSH Public Key To Master01
  ansible.builtin.copy:
    src: "{{ ssh_pubkey_path }}"
    dest: "/home/{{ agent_user }}/.ssh/id_ed25519.pub"
    owner: "{{ agent_user }}"
    group: "{{ agent_user }}"
    mode: "0644"
  delegate_to: master01
  become: true
